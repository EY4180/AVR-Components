#include <avr/io.h>
#include <avr/pgmspace.h>
#include <stdint.h>

#define ADDRESS 0b01111000
#define READ 0xFF
#define WRITE 0x00

#define INSTRUCTION 0x80
#define DATA 0x40

FUSES = {
	.low = FUSE_CKSEL0,
	.high = FUSE_SPIEN & FUSE_BODLEVEL2 & FUSE_BODLEVEL1,
	.extended = EFUSE_DEFAULT};

const uint8_t font[96][4] PROGMEM = {
	{0x00, 0x00, 0x00, 0x00}, //
	{0x36, 0x00, 0x00, 0x00}, // !
	{0x06, 0x00, 0x00, 0x06}, // "
	{0x36, 0x49, 0x49, 0x36}, // #
	{0x06, 0x49, 0x49, 0x30}, // $
	{0x36, 0x49, 0x49, 0x36}, // %
	{0x36, 0x49, 0x49, 0x36}, // &
	{0x06, 0x00, 0x00, 0x00}, // '
	{0x36, 0x41, 0x41, 0x00}, // (
	{0x41, 0x41, 0x36, 0x00}, // )
	{0x06, 0x09, 0x09, 0x06}, // *
	{0x36, 0x08, 0x08, 0x00}, // +
	{0x30, 0x00, 0x00, 0x00}, // ,
	{0x08, 0x08, 0x00, 0x00}, // -
	{0x30, 0x00, 0x00, 0x00}, // .
	{0x30, 0x08, 0x08, 0x06}, // /
	{0x36, 0x41, 0x41, 0x36}, // 0
	{0x36, 0x00, 0x00, 0x00}, // 1
	{0x30, 0x49, 0x49, 0x06}, // 2
	{0x49, 0x49, 0x36, 0x00}, // 3
	{0x06, 0x08, 0x08, 0x36}, // 4
	{0x06, 0x49, 0x49, 0x30}, // 5
	{0x36, 0x49, 0x49, 0x30}, // 6
	{0x01, 0x01, 0x36, 0x00}, // 7
	{0x36, 0x49, 0x49, 0x36}, // 8
	{0x06, 0x49, 0x49, 0x36}, // 9
	{0x36, 0x00, 0x00, 0x00}, // :
	{0x36, 0x00, 0x00, 0x00}, // ;
	{0x36, 0x41, 0x41, 0x00}, // <
	{0x48, 0x48, 0x00, 0x00}, // =
	{0x41, 0x41, 0x36, 0x00}, // >
	{0x30, 0x09, 0x09, 0x06}, // ?
	{0x36, 0x49, 0x49, 0x36}, // @
	{0x36, 0x09, 0x09, 0x36}, // A
	{0x36, 0x49, 0x49, 0x36}, // B
	{0x36, 0x41, 0x41, 0x00}, // C
	{0x30, 0x48, 0x48, 0x36}, // D
	{0x36, 0x49, 0x49, 0x00}, // E
	{0x36, 0x09, 0x09, 0x00}, // F
	{0x36, 0x49, 0x49, 0x30}, // G
	{0x36, 0x08, 0x08, 0x36}, // H
	{0x36, 0x00, 0x00, 0x00}, // I
	{0x40, 0x40, 0x36, 0x00}, // J
	{0x36, 0x08, 0x08, 0x36}, // K
	{0x36, 0x40, 0x40, 0x00}, // L
	{0x36, 0x01, 0x01, 0x36}, // M
	{0x36, 0x01, 0x01, 0x36}, // N
	{0x36, 0x41, 0x41, 0x36}, // O
	{0x36, 0x09, 0x09, 0x06}, // P
	{0x06, 0x09, 0x09, 0x36}, // Q
	{0x36, 0x01, 0x01, 0x00}, // R
	{0x06, 0x49, 0x49, 0x30}, // S
	{0x36, 0x48, 0x48, 0x00}, // T
	{0x36, 0x40, 0x40, 0x36}, // U
	{0x36, 0x40, 0x40, 0x36}, // V
	{0x36, 0x40, 0x40, 0x36}, // W
	{0x36, 0x08, 0x08, 0x36}, // X
	{0x06, 0x08, 0x08, 0x36}, // Y
	{0x30, 0x49, 0x49, 0x06}, // Z
	{0x36, 0x41, 0x41, 0x00}, // [
	{0x06, 0x08, 0x08, 0x30}, // "\"
	{0x41, 0x41, 0x36, 0x00}, // ]
	{0x06, 0x01, 0x01, 0x06}, // ^
	{0x40, 0x40, 0x00, 0x00}, // _
	{0x06, 0x00, 0x00, 0x00}, // `
	{0x30, 0x49, 0x49, 0x36}, // a
	{0x36, 0x48, 0x48, 0x30}, // b
	{0x36, 0x41, 0x41, 0x00}, // c
	{0x30, 0x48, 0x48, 0x36}, // d
	{0x36, 0x49, 0x49, 0x00}, // e
	{0x36, 0x09, 0x09, 0x00}, // f
	{0x06, 0x49, 0x49, 0x36}, // g
	{0x36, 0x08, 0x08, 0x30}, // h
	{0x36, 0x00, 0x00, 0x00}, // i
	{0x40, 0x40, 0x36, 0x00}, // j
	{0x36, 0x08, 0x08, 0x36}, // k
	{0x36, 0x00, 0x00, 0x00}, // l
	{0x36, 0x01, 0x01, 0x36}, // m
	{0x36, 0x01, 0x01, 0x36}, // n
	{0x36, 0x41, 0x41, 0x36}, // o
	{0x36, 0x09, 0x09, 0x06}, // p
	{0x06, 0x09, 0x09, 0x36}, // q
	{0x36, 0x01, 0x01, 0x00}, // r
	{0x06, 0x49, 0x49, 0x30}, // s
	{0x36, 0x48, 0x48, 0x00}, // t
	{0x36, 0x40, 0x40, 0x36}, // u
	{0x36, 0x40, 0x40, 0x36}, // v
	{0x36, 0x40, 0x40, 0x36}, // w
	{0x36, 0x08, 0x08, 0x36}, // x
	{0x06, 0x48, 0x48, 0x36}, // y
	{0x30, 0x49, 0x49, 0x06}, // z
	{0x36, 0x41, 0x41, 0x00}, // {
	{0x36, 0x00, 0x00, 0x00}, // |
	{0x41, 0x41, 0x36, 0x00}, // }
	{0x30, 0x08, 0x08, 0x06}, // ~
	{0x00, 0x00, 0x00, 0x00}};

void twi_block()
{
	while ((TWCR & (1 << TWINT)) == 0)
	{
		continue;
	}
}

void twi_send(const uint8_t data)
{
	TWDR = data;
	TWCR = _BV(TWINT) | _BV(TWEN) | _BV(TWEA);
	twi_block();
}

void twi_start(const uint8_t address, const uint8_t rw)
{
	// send start condition
	TWCR = _BV(TWINT) | _BV(TWSTA) | _BV(TWEN) | _BV(TWEA);
	twi_block();

	// send the address first
	TWDR = __builtin_avr_insert_bits(0xfffffff0, rw, address);
	TWCR = _BV(TWINT) | _BV(TWEN) | _BV(TWEA);
	twi_block();
}

void twi_stop()
{
	TWCR = _BV(TWINT) | _BV(TWEN) | _BV(TWEA) | _BV(TWSTO);
}

void twi_send_command(const uint8_t *control, const size_t size)
{
	twi_start(ADDRESS, WRITE);

	for (size_t i = 0; i < size; ++i)
	{
		// send control byte
		twi_send(INSTRUCTION);
		// send command
		twi_send(control[i]);
	}

	// send stop condition
	twi_stop();
}

void twi_send_data(const uint8_t *data, const size_t size)
{
	twi_start(ADDRESS, WRITE);

	// send control byte
	twi_send(DATA);

	// send data
	for (size_t n = 0; n < size; ++n)
	{
		twi_send(data[n]);
	}

	// send stop condition
	twi_stop();
}

void clear_display()
{
	for (size_t page = 0xB0; page < 0xB8; ++page)
	{
		const uint8_t set_page[] = {
			0x20, // set addressing mode
			0x02, // set page addressing mode
			page, // change to correct page
			0x00, // set lower nibble column address to 0
			0x10  // set higher nibble column address to 0
		};

		const size_t command_length = sizeof(set_page) / sizeof(*set_page);

		twi_send_command(set_page, command_length);
		
		twi_start(ADDRESS, WRITE);

		// send control byte
		twi_send(DATA);

		// send data
		for (size_t n = 0; n < 128; ++n)
		{
			twi_send(0x00);
		}

		// send stop condition
		twi_stop();
	}
}

void send_string(const char *string, const uint16_t position, const size_t length)
{
	uint8_t set_page[] = {
		0x20,							// set addressing mode
		0x02,							// set page addressing mode
		position >> 8,					// change to correct page
		position & 0xF,					// set lower nibble column address to 0
		0x10 | ((position & 0xF0) >> 4) // set higher nibble column address to 0
	};

	twi_send_command(set_page, sizeof(set_page) / sizeof(*set_page));

	for (size_t i = 0; i < length; i++)
	{
		size_t index = string[i] - ' ';
		uint8_t pixels[5];

		for (size_t j = 0; j < 4; j++)
		{
			pixels[j] = pgm_read_byte(&font[index][j]);
		}

		pixels[4] = 0x00;

		twi_send_data(pixels, 5);
	}
}

void init_display()
{
	uint8_t startup[] = {
		0xA8, // set multiplex ratio
		0xFF, // set multiplex ratio to 64
		0xD3, // set vertical shift
		0x00, // no vertical shift
		0x40, // display start line set to 0
		0xA0, // no segment remapping
		0xC0, // scan from top to bottom
		0x81, // set contrast control
		0x7F, // max contrast value
		0xA4, // entire display on (RAM content)
		0xA6, // 0 = off, 1 = on
		0xD5, // set display clock divide
		0xF0, // max oscillator frequency with no divide
		0x20, // set addressing mode
		0x02, // set page addressing mode
		0xB0, // start on page 0
		0x8D, // set charge pump
		0x14, // enable charge pump
		0xAF  // turn display on
	};

	size_t command_length = sizeof(startup) / sizeof(*startup);

	TWBR = 0xFF; // set baud rate
	twi_send_command(startup, command_length);
}

int main()
{
	__builtin_avr_cli();
	
	init_display();
	clear_display();
	send_string("Hello, world", 0xB000, 12);

	__builtin_avr_sei();

	while (1)
	{
		continue;
	}

	return 0;
}
