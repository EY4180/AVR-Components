#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <stdint.h>

#define ADDRESS 0b01111000

FUSES = {
	.low = FUSE_CKSEL0,
	.high = FUSE_SPIEN & FUSE_BODLEVEL2 & FUSE_BODLEVEL1,
	.extended = EFUSE_DEFAULT};

const uint8_t font[96][4] PROGMEM = {
	{0x00, 0x00, 0x00, 0x00}, //
	{0x36, 0x00, 0x00, 0x00}, // !
	{0x06, 0x00, 0x00, 0x06}, // "
	{0x36, 0x49, 0x49, 0x36}, // #
	{0x06, 0x49, 0x49, 0x30}, // $
	{0x36, 0x49, 0x49, 0x36}, // %
	{0x36, 0x49, 0x49, 0x36}, // &
	{0x06, 0x00, 0x00, 0x00}, // '
	{0x36, 0x41, 0x41, 0x00}, // (
	{0x41, 0x41, 0x36, 0x00}, // )
	{0x06, 0x09, 0x09, 0x06}, // *
	{0x36, 0x08, 0x08, 0x00}, // +
	{0x30, 0x00, 0x00, 0x00}, // ,
	{0x08, 0x08, 0x00, 0x00}, // -
	{0x30, 0x00, 0x00, 0x00}, // .
	{0x30, 0x08, 0x08, 0x06}, // /
	{0x36, 0x41, 0x41, 0x36}, // 0
	{0x36, 0x00, 0x00, 0x00}, // 1
	{0x30, 0x49, 0x49, 0x06}, // 2
	{0x49, 0x49, 0x36, 0x00}, // 3
	{0x06, 0x08, 0x08, 0x36}, // 4
	{0x06, 0x49, 0x49, 0x30}, // 5
	{0x36, 0x49, 0x49, 0x30}, // 6
	{0x01, 0x01, 0x36, 0x00}, // 7
	{0x36, 0x49, 0x49, 0x36}, // 8
	{0x06, 0x49, 0x49, 0x36}, // 9
	{0x36, 0x00, 0x00, 0x00}, // :
	{0x36, 0x00, 0x00, 0x00}, // ;
	{0x36, 0x41, 0x41, 0x00}, // <
	{0x48, 0x48, 0x00, 0x00}, // =
	{0x41, 0x41, 0x36, 0x00}, // >
	{0x30, 0x09, 0x09, 0x06}, // ?
	{0x36, 0x49, 0x49, 0x36}, // @
	{0x36, 0x09, 0x09, 0x36}, // A
	{0x36, 0x49, 0x49, 0x36}, // B
	{0x36, 0x41, 0x41, 0x00}, // C
	{0x30, 0x48, 0x48, 0x36}, // D
	{0x36, 0x49, 0x49, 0x00}, // E
	{0x36, 0x09, 0x09, 0x00}, // F
	{0x36, 0x49, 0x49, 0x30}, // G
	{0x36, 0x08, 0x08, 0x36}, // H
	{0x36, 0x00, 0x00, 0x00}, // I
	{0x40, 0x40, 0x36, 0x00}, // J
	{0x36, 0x08, 0x08, 0x36}, // K
	{0x36, 0x40, 0x40, 0x00}, // L
	{0x36, 0x01, 0x01, 0x36}, // M
	{0x36, 0x01, 0x01, 0x36}, // N
	{0x36, 0x41, 0x41, 0x36}, // O
	{0x36, 0x09, 0x09, 0x06}, // P
	{0x06, 0x09, 0x09, 0x36}, // Q
	{0x36, 0x01, 0x01, 0x00}, // R
	{0x06, 0x49, 0x49, 0x30}, // S
	{0x36, 0x48, 0x48, 0x00}, // T
	{0x36, 0x40, 0x40, 0x36}, // U
	{0x36, 0x40, 0x40, 0x36}, // V
	{0x36, 0x40, 0x40, 0x36}, // W
	{0x36, 0x08, 0x08, 0x36}, // X
	{0x06, 0x08, 0x08, 0x36}, // Y
	{0x30, 0x49, 0x49, 0x06}, // Z
	{0x36, 0x41, 0x41, 0x00}, // [
	{0x06, 0x08, 0x08, 0x30}, // "\"
	{0x41, 0x41, 0x36, 0x00}, // ]
	{0x06, 0x01, 0x01, 0x06}, // ^
	{0x40, 0x40, 0x00, 0x00}, // _
	{0x06, 0x00, 0x00, 0x00}, // `
	{0x30, 0x49, 0x49, 0x36}, // a
	{0x36, 0x48, 0x48, 0x30}, // b
	{0x36, 0x41, 0x41, 0x00}, // c
	{0x30, 0x48, 0x48, 0x36}, // d
	{0x36, 0x49, 0x49, 0x00}, // e
	{0x36, 0x09, 0x09, 0x00}, // f
	{0x06, 0x49, 0x49, 0x36}, // g
	{0x36, 0x08, 0x08, 0x30}, // h
	{0x36, 0x00, 0x00, 0x00}, // i
	{0x40, 0x40, 0x36, 0x00}, // j
	{0x36, 0x08, 0x08, 0x36}, // k
	{0x36, 0x00, 0x00, 0x00}, // l
	{0x36, 0x01, 0x01, 0x36}, // m
	{0x36, 0x01, 0x01, 0x36}, // n
	{0x36, 0x41, 0x41, 0x36}, // o
	{0x36, 0x09, 0x09, 0x06}, // p
	{0x06, 0x09, 0x09, 0x36}, // q
	{0x36, 0x01, 0x01, 0x00}, // r
	{0x06, 0x49, 0x49, 0x30}, // s
	{0x36, 0x48, 0x48, 0x00}, // t
	{0x36, 0x40, 0x40, 0x36}, // u
	{0x36, 0x40, 0x40, 0x36}, // v
	{0x36, 0x40, 0x40, 0x36}, // w
	{0x36, 0x08, 0x08, 0x36}, // x
	{0x06, 0x48, 0x48, 0x36}, // y
	{0x30, 0x49, 0x49, 0x06}, // z
	{0x36, 0x41, 0x41, 0x00}, // {
	{0x36, 0x00, 0x00, 0x00}, // |
	{0x41, 0x41, 0x36, 0x00}, // }
	{0x30, 0x08, 0x08, 0x06}, // ~
	{0x00, 0x00, 0x00, 0x00}};

void twi_block()
{
	while ((TWCR & (1 << TWINT)) == 0)
	{
		continue;
	}
}

void twi_send_command(char *command, int size)
{
	// send start condition
	TWCR = (1 << TWINT) | (1 << TWSTA) | (1 << TWEN) | _BV(TWEA);
	twi_block();

	// send the address first
	TWDR = ADDRESS;
	TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
	twi_block();

	for (int i = 0; i < size; i++)
	{
		// send control byte
		TWDR = 0x80;
		TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
		twi_block();

		// send command
		TWDR = command[i];
		TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
		twi_block();
	}
	// send stop condition
	TWCR = (1 << TWINT) | (1 << TWEN) | (1 << TWSTO | _BV(TWEA));
}

void twi_send_data(char *data, int size)
{
	// send start condition
	TWCR = (1 << TWINT) | (1 << TWSTA) | (1 << TWEN) | _BV(TWEA);
	twi_block();

	// send the address first
	TWDR = ADDRESS;
	TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
	twi_block();

	// send control byte
	TWDR = 0x40;
	TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
	twi_block();

	// send data
	for (int n = 0; n < size; n++)
	{
		TWDR = data[n];
		TWCR = (1 << TWINT) | (1 << TWEN) | _BV(TWEA);
		twi_block();
	}

	// send stop condition
	TWCR = (1 << TWINT) | (1 << TWEN) | (1 << TWSTO) | _BV(TWEA);
}

void clear_display()
{
	for (int page = 0xB0; page < 0xB8; page++)
	{
		char set_page[] = {
			0x20, // set addressing mode
			0x02, // set page addressing mode
			page, // change to correct page
			0x00, // set lower nibble column address to 0
			0x10  // set higher nibble column address to 0
		};

		int command_length = sizeof(set_page) / sizeof(*set_page);

		twi_send_command(set_page, command_length);
		char empty_page[128];
		for (int i = 0; i < 128; i++)
		{
			empty_page[i] = 0;
		}

		twi_send_data(empty_page, 128);
	}
}

void send_string(char *string, int position, int length)
{
	char set_page[] = {
		0x20,							// set addressing mode
		0x02,							// set page addressing mode
		position >> 8,					// change to correct page
		position & 0xF,					// set lower nibble column address to 0
		0x10 | ((position & 0xF0) >> 4) // set higher nibble column address to 0
	};

	twi_send_command(set_page, sizeof(set_page) / sizeof(*set_page));

	for (int i = 0; i < length; i++)
	{
		int index = string[i] - ' ';
		char pixels[5];

		for (int j = 0; j < 4; j++)
		{
			pixels[j] = pgm_read_byte(&font[index][j]);
		}

		pixels[4] = 0x00;

		twi_send_data(pixels, 5);
	}
}

void init_display()
{
	char startup[] = {
		0xA8, // set multiplex ratio
		0xFF, // set multiplex ratio to 64
		0xD3, // set vertical shift
		0x00, // no vertical shift
		0x40, // display start line set to 0
		0xA0, // no segment remapping
		0xC0, // scan from top to bottom
		0x81, // set contrast control
		0x7F, // max contrast value
		0xA4, // entire display on (RAM content)
		0xA6, // 0 = off, 1 = on
		0xD5, // set display clock divide
		0xF0, // max oscillator frequency with no divide
		0x20, // set addressing mode
		0x02, // set page addressing mode
		0xB0, // start on page 0
		0x8D, // set charge pump
		0x14, // enable charge pump
		0xAF  // turn display on
	};

	int command_length = sizeof(startup) / sizeof(*startup);

	TWBR = 0xFF; // set baud rate
	twi_send_command(startup, command_length);
}

int main()
{
	while (1)
	{
		continue;
	}
	return 0;
}
